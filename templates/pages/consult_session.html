{% extends "layouts/base.html" %}
{% load static %}
{% load path_extras %}
{% block title %} Sesión de Consulta {% endblock %}
{% block content %}
<div class="container-fluid py-4">
  <!-- Toast messages -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index:1080;">
    {% for message in messages %}
      <div class="toast align-items-center text-white bg-{% if 'error' in message.tags or 'danger' in message.tags %}danger{% elif 'warning' in message.tags %}warning text-dark{% else %}success{% endif %} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="4000">
        <div class="d-flex">
          <div class="toast-body small">{{ message }}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="row mb-4">
    <div class="col-12">
      <div class="card my-4">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-1">
          <div class="bg-gradient-success shadow-success border-radius-lg pt-4 pb-3 d-flex justify-content-between align-items-center">
            <h6 class="text-white text-capitalize ps-3 mb-0">Sesión con {{ consultation.patient.first_name }} {{ consultation.patient.last_name }}</h6>
            <a href="{% url 'consult' %}" class="btn btn-sm btn-outline-light me-3">Volver</a>
          </div>
        </div>
        <div class="card-body pt-3">
          <div class="row mb-3">
            <div class="col-md-3">
              <p class="text-xs text-secondary mb-1">Fecha</p>
              <h6 class="mb-0">{{ consultation.date|date:"d/m/Y" }}</h6>
            </div>
            <div class="col-md-3">
              <p class="text-xs text-secondary mb-1">Hora</p>
              <h6 class="mb-0">{{ consultation.time }}</h6>
            </div>
            <div class="col-md-3">
              <p class="text-xs text-secondary mb-1">Consultorio</p>
              <h6 class="mb-0">{{ consultation.consultory }}</h6>
            </div>
            <div class="col-md-3">
              <p class="text-xs text-secondary mb-1">Profesional</p>
              <h6 class="mb-0">{{ consultation.professional.first_name }} {{ consultation.professional.last_name }}</h6>
            </div>
          </div>
          <hr>
          <div class="row">
            <!-- Notas -->
            <div class="col-lg-6 mb-4">
              <div class="card h-100 shadow-none border">
                <div class="card-header pb-0">
                  <h6 class="mb-0">Agregar Nota</h6>
                  <p class="text-xs text-secondary mb-0">Crea notas para esta sesión. Usa un título opcional.</p>
                </div>
                <div class="card-body pt-3">
                  <form method="post" class="mb-4">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_note">
                    {{ note_form.non_field_errors }}
                    <div class="mb-3">
                      {{ note_form.title.label_tag }}
                      {{ note_form.title }}
                      {% if note_form.title.errors %}
                        <div class="text-danger small">{{ note_form.title.errors|join:', ' }}</div>
                      {% endif %}
                    </div>
                    <div class="mb-3">
                      {{ note_form.content.label_tag }}
                      {{ note_form.content }}
                      {% if note_form.content.errors %}
                        <div class="text-danger small">{{ note_form.content.errors|join:', ' }}</div>
                      {% endif %}
                    </div>
                    <button type="submit" class="btn btn-success w-100">Guardar Nota</button>
                  </form>
                  <h6 class="mb-3">Notas de la Sesión</h6>
                  <div class="list-group mb-0" style="max-height: 420px; overflow-y:auto;">
                    {% for note in notes %}
                      <div class="list-group-item border rounded-2 mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <strong class="d-block">{% if note.title %}{{ note.title }}{% else %}Nota #{{ note.id }}{% endif %}</strong>
                            <small class="text-secondary">{{ note.created_at|date:"d/m/Y H:i" }} · {{ note.created_by.first_name }} {{ note.created_by.last_name }}</small>
                          </div>
                          <div class="ms-2">
                            <button class="btn btn-sm btn-link text-primary p-1" data-bs-toggle="modal" data-bs-target="#editNoteModal-{{ note.id }}" title="Editar"><i class="material-icons" style="font-size:18px;">editar</i></button>
                            <button class="btn btn-sm btn-link text-danger p-1" data-bs-toggle="modal" data-bs-target="#deleteNoteModal-{{ note.id }}" title="Eliminar"><i class="material-icons" style="font-size:18px;">eliminar</i></button>
                          </div>
                        </div>
                        <p class="mb-1 mt-2" style="white-space: pre-wrap;">{{ note.content }}</p>
                      </div>

                      <!-- Edit Note Modal -->
                      <div class="modal fade" id="editNoteModal-{{ note.id }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h6 class="modal-title">Editar Nota</h6>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form method="post">
                              <div class="modal-body">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="edit_note">
                                <input type="hidden" name="note_id" value="{{ note.id }}">
                                <div class="mb-3">
                                  <label class="form-label">Título</label>
                                  <input type="text" name="editnote-title" value="{{ note.title }}" class="form-control" placeholder="Título (opcional)">
                                </div>
                                <div class="mb-3">
                                  <label class="form-label">Contenido</label>
                                  <textarea name="editnote-content" rows="5" class="form-control" required>{{ note.content }}</textarea>
                                </div>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                              </div>
                            </form>
                          </div>
                        </div>
                      </div>

                      <!-- Delete Note Modal -->
                      <div class="modal fade" id="deleteNoteModal-{{ note.id }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h6 class="modal-title">Eliminar Nota</h6>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form method="post">
                              <div class="modal-body">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="delete_note">
                                <input type="hidden" name="note_id" value="{{ note.id }}">
                                <p class="mb-0">¿Estás seguro de que quieres eliminar esta nota?</p>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-danger">Eliminar</button>
                              </div>
                            </form>
                          </div>
                        </div>
                      </div>
                    {% empty %}
                      <p class="text-secondary">No hay notas registradas aún.</p>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            <!-- Adjuntos -->
            <div class="col-lg-6 mb-4">
              <div class="card h-100 shadow-none border">
                <div class="card-header pb-0">
                  <h6 class="mb-0">Agregar Documento</h6>
                  <p class="text-xs text-secondary mb-0">PDF, DOC, DOCX, TXT, MD. Tamaño según configuración.</p>
                </div>
                <div class="card-body pt-3">
                  <form method="post" enctype="multipart/form-data" class="mb-4">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_attachment">
                    {{ attachment_form.non_field_errors }}
                    <div class="mb-3">
                      {{ attachment_form.file_type.label_tag }}
                      {{ attachment_form.file_type }}
                      {% if attachment_form.file_type.errors %}
                        <div class="text-danger small">{{ attachment_form.file_type.errors|join:', ' }}</div>
                      {% endif %}
                    </div>
                    <div class="mb-3">
                      {{ attachment_form.display_name.label_tag }}
                      {{ attachment_form.display_name }}
                      {% if attachment_form.display_name.errors %}
                        <div class="text-danger small">{{ attachment_form.display_name.errors|join:', ' }}</div>
                      {% endif %}
                    </div>
                    <div class="mb-3">
                      {{ attachment_form.file.label_tag }}
                      {{ attachment_form.file }}
                      {% if attachment_form.file.errors %}
                        <div class="text-danger small">{{ attachment_form.file.errors|join:', ' }}</div>
                      {% endif %}
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Subir Documento</button>
                  </form>
                  <h6 class="mb-3">Documentos</h6>
                  {% if grouped_attachments %}
                    <div class="accordion" id="attachmentsAccordion">
                      {% for type, items in grouped_attachments.items %}
                        <div class="accordion-item mb-2">
                          <h2 class="accordion-header" id="heading-{{ type }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ type }}" aria-expanded="false" aria-controls="collapse-{{ type }}">
                              {{ type|title }} ({{ items|length }})
                            </button>
                          </h2>
                          <div id="collapse-{{ type }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ type }}" data-bs-parent="#attachmentsAccordion">
                            <div class="accordion-body p-2">
                              <ul class="list-group">
                                {% for att in items %}
                                  <li class="list-group-item small">
                                    <div class="d-flex justify-content-between align-items-start">
                                      <div class="me-2">
                                        {% with ext=att.file.name|file_ext %}
                                          {% if ext == 'pdf' %}
                                            <i class="material-icons text-danger me-1" style="font-size:16px;">picture_as_pdf</i>
                                          {% elif ext == 'doc' or ext == 'docx' %}
                                            <i class="material-icons text-primary me-1" style="font-size:16px;">description</i>
                                          {% elif ext == 'txt' or ext == 'md' %}
                                            <i class="material-icons text-secondary me-1" style="font-size:16px;">article</i>
                                          {% else %}
                                            <i class="material-icons text-dark me-1" style="font-size:16px;">insert_drive_file</i>
                                          {% endif %}
                                        {% endwith %}
                                        <a href="{{ att.file.url }}" target="_blank">{% if att.display_name %}{{ att.display_name }}{% else %}{{ att.file.name|basename }}{% endif %}</a>
                                        <span class="text-secondary ms-2">{{ att.uploaded_at|date:"d/m/Y H:i" }}</span>
                                      </div>
                                      <div class="text-nowrap">
                                        <button class="btn btn-sm btn-link text-primary p-1" data-bs-toggle="modal" data-bs-target="#editAttachmentModal-{{ att.id }}" title="Editar"><i class="material-icons" style="font-size:18px;">editar</i></button>
                                        <button class="btn btn-sm btn-link text-danger p-1" data-bs-toggle="modal" data-bs-target="#deleteAttachmentModal-{{ att.id }}" title="Eliminar"><i class="material-icons" style="font-size:18px;">eliminar</i></button>
                                      </div>
                                    </div>
                                  </li>

                                  <!-- Edit Attachment Modal -->
                                  <div class="modal fade" id="editAttachmentModal-{{ att.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                      <div class="modal-content">
                                        <div class="modal-header">
                                          <h6 class="modal-title">Editar Adjunto</h6>
                                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <form method="post">
                                          <div class="modal-body">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="edit_attachment">
                                            <input type="hidden" name="attachment_id" value="{{ att.id }}">
                                            <div class="mb-3">
                                              <label class="form-label">Nombre</label>
                                              <input type="text" name="rename-display_name" value="{{ att.display_name }}" class="form-control" placeholder="Nombre (opcional)">
                                            </div>
                                            <div class="mb-3">
                                              <label class="form-label">Tipo</label>
                                              <select name="rename-file_type" class="form-control">
                                                {% for val,label in att.TYPE_CHOICES %}
                                                  <option value="{{ val }}" {% if val == att.file_type %}selected{% endif %}>{{ label }}</option>
                                                {% endfor %}
                                              </select>
                                            </div>
                                          </div>
                                          <div class="modal-footer">
                                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                                          </div>
                                        </form>
                                      </div>
                                    </div>
                                  </div>

                                  <!-- Delete Attachment Modal -->
                                  <div class="modal fade" id="deleteAttachmentModal-{{ att.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                      <div class="modal-content">
                                        <div class="modal-header">
                                          <h6 class="modal-title">Eliminar Adjunto</h6>
                                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <form method="post">
                                          <div class="modal-body">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="delete_attachment">
                                            <input type="hidden" name="attachment_id" value="{{ att.id }}">
                                            <p class="mb-0">¿Estás seguro de que quieres eliminar este adjunto?</p>
                                          </div>
                                          <div class="modal-footer">
                                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" class="btn btn-danger">Eliminar</button>
                                          </div>
                                        </form>
                                      </div>
                                    </div>
                                  </div>
                                {% endfor %}
                              </ul>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% else %}
                    <p class="text-secondary">No hay documentos subidos.</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var toastElList = [].slice.call(document.querySelectorAll('.toast'));
    toastElList.map(function (toastEl) { return new bootstrap.Toast(toastEl).show(); });
  });
</script>
{% endblock content %}