{% extends "layouts/base.html" %}
{% load static %}

{% block title %} Perfil {% endblock %}
{% block content %}
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <div class="card my-4">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
          <div class="bg-gradient-success shadow-success border-radius-lg pt-4 pb-3">
            <h6 class="text-white text-capitalize ps-3">Perfil del Profesional</h6>
          </div>
        </div>
        <div class="card-body px-4 pb-4">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} text-white">{{ message }}</div>
            {% endfor %}
          {% endif %}

          <div class="row">
            <div class="col-lg-4">
              <div class="text-center mb-4">
                <div class="avatar avatar-xxl">
                  {% if professional and professional.profile_picture %}
                    <img src="{{ professional.profile_picture.url }}" class="border-radius-lg shadow" style="width:160px;height:160px;object-fit:cover;" />
                  {% else %}
                    <img src="{% static 'img/avilogo.png' %}" class="border-radius-lg shadow" style="width:160px;height:160px;object-fit:cover;" />
                  {% endif %}
                </div>
                <h6 class="mt-3 mb-0">{{ professional.first_name }} {{ professional.last_name }}</h6>
                <p class="text-xs text-secondary">{{ professional.get_role_display }}</p>
              </div>
              <div class="mb-4">
                <h6>Contactos</h6>
                <ul class="list-group mb-3">
                  {% for c in contacts %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <strong>{{ c.get_type_display }}:</strong> {{ c.label|default:'-' }}<br>
                        <span class="text-xs text-secondary">{{ c.value }}</span>
                      </div>
                      <form method="post" class="ms-2">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete_contact">
                        <input type="hidden" name="contact_id" value="{{ c.id }}">
                        <button class="btn btn-sm btn-outline-danger">Eliminar</button>
                      </form>
                    </li>
                  {% empty %}
                    <li class="list-group-item">Sin contactos</li>
                  {% endfor %}
                </ul>
                {% if professional %}
                <form method="post" class="border rounded p-3">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="add_contact">
                  <div class="mb-2">
                    <label class="form-label">Tipo</label>
                    {{ contact_form.type }}
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Etiqueta/Descripción</label>
                    {{ contact_form.label }}
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Valor</label>
                    {{ contact_form.value }}
                  </div>
                  <button class="btn btn-success w-100">Agregar Contacto</button>
                </form>
                {% endif %}
              </div>
            </div>
            <div class="col-lg-8">
              {% if professional %}
              <form method="post" enctype="multipart/form-data" class="border rounded p-3 mb-4">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_profile">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Nombre</label>
                    {{ profile_form.first_name }}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Apellido</label>
                    {{ profile_form.last_name }}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Correo</label>
                    {{ profile_form.email }}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Teléfono</label>
                    {{ profile_form.phone }}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Especialidad</label>
                    {{ profile_form.specialty }}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Foto de Perfil</label>
                    {{ profile_form.profile_picture }}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Fecha de Nacimiento</label>
                    {{ profile_form.birth_date }}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Género</label>
                    {{ profile_form.gender }}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Nacionalidad</label>
                    {{ profile_form.nationality }}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Tipo de Identificación</label>
                    {{ profile_form.identification_type }}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Número de Identificación</label>
                    {{ profile_form.identification_number }}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Extensión</label>
                    {{ profile_form.identification_extension }}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">N° Licencia</label>
                    {{ profile_form.license_number }}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Años de Experiencia</label>
                    {{ profile_form.years_experience }}
                  </div>
                  <div class="col-12 mb-3">
                    <label class="form-label">Biografía</label>
                    {{ profile_form.biography }}
                  </div>
                  <div class="col-12 mb-3">
                    <label class="form-label">Educación</label>
                    {{ profile_form.education }}
                  </div>
                  <div class="col-12 mb-3">
                    <label class="form-label">Especializaciones</label>
                    {{ profile_form.specializations }}
                  </div>
                  <div class="col-12 mb-3">
                    <label class="form-label">Idiomas</label>
                    {{ profile_form.languages_spoken }}
                  </div>
                </div>
                <button class="btn btn-primary">Guardar Perfil</button>
              </form>

              <div class="border rounded p-3">
                <h6 class="mb-3">Disponibilidad Semanal</h6>
                <form method="post">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="update_availability">
                  <div class="table-responsive mb-3">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Día</th>
                          <th>Inicio</th>
                          <th>Fin</th>
                          <th>Cerrado</th>
                        </tr>
                      </thead>
                      <tbody>
                      {% for a in availability %}
                        <tr>
                          <td>{{ a.get_weekday_display }}</td>
                          <td><input type="time" name="availability-{{ a.weekday }}-start" value="{{ a.start_time|default:'' }}" class="form-control form-control-sm" {% if a.is_closed %}disabled{% endif %}></td>
                          <td><input type="time" name="availability-{{ a.weekday }}-end" value="{{ a.end_time|default:'' }}" class="form-control form-control-sm" {% if a.is_closed %}disabled{% endif %}></td>
                          <td class="text-center"><input type="checkbox" name="availability-{{ a.weekday }}-closed" class="form-check-input" {% if a.is_closed %}checked{% endif %}></td>
                        </tr>
                      {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  <button class="btn btn-sm btn-success">Guardar Disponibilidad</button>
                </form>
              </div>
              <div class="border rounded p-3 mt-4">
                <h6 class="mb-3">Excepciones por Fecha</h6>
                <form method="post" class="row g-2 mb-3">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="add_exception" />
                  <div class="col-md-3">
                    {{ exception_form.date }}
                  </div>
                  <div class="col-md-3">
                    {{ exception_form.start_time }}
                  </div>
                  <div class="col-md-3">
                    {{ exception_form.end_time }}
                  </div>
                  <div class="col-md-2 d-flex align-items-center">
                    <div class="form-check mt-1">
                      {{ exception_form.is_closed }} <label class="form-check-label">Cerrado</label>
                    </div>
                  </div>
                  <div class="col-md-1">
                    <button class="btn btn-sm btn-success w-100">Agregar</button>
                  </div>
                </form>
                <div class="table-responsive">
                  <table class="table table-sm mb-0">
                    <thead>
                      <tr>
                        <th>Fecha</th>
                        <th>Inicio</th>
                        <th>Fin</th>
                        <th>Cerrado</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for ex in exceptions %}
                      <tr>
                        <td>{{ ex.date|date:'d/m/Y' }}</td>
                        <td>{{ ex.start_time|default:'-' }}</td>
                        <td>{{ ex.end_time|default:'-' }}</td>
                        <td>{% if ex.is_closed %}<span class="badge bg-gradient-danger">Sí</span>{% else %}<span class="badge bg-gradient-success">No</span>{% endif %}</td>
                        <td>
                          <form method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete_exception" />
                            <input type="hidden" name="exception_id" value="{{ ex.id }}" />
                            <button class="btn btn-sm btn-outline-danger">Eliminar</button>
                          </form>
                        </td>
                      </tr>
                      {% empty %}
                      <tr><td colspan="5" class="text-secondary small">Sin excepciones futuras</td></tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              {% else %}
                <p class="text-secondary">Este usuario no está vinculado a un profesional.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}