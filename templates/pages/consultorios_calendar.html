{% extends "layouts/base.html" %}
{% block title %} Calendario Consultorios {% endblock %}
{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card my-4">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
          <div class="bg-gradient-success shadow-success border-radius-lg pt-4 pb-3 d-flex justify-content-between align-items-center">
            <h6 class="text-white text-capitalize ps-3 mb-0">Calendario</h6>
            <a href="{% url 'consult' %}" class="btn btn-sm btn-outline-light">Nueva Consulta</a>
          </div>
        </div>
        <div class="card-body px-4 pb-2">
          <form class="row g-2 mb-3" id="calendarFilters">
            <div class="col-md-6 col-lg-4">
              <label class="form-label text-xs">Consultorio</label>
              <select class="form-select" name="consultorio">
                <option value="">Todos</option>
                {% for c in consultorios %}
                  <option value="{{ c.id }}" {% if selected_consultorio_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3 col-lg-2 d-flex align-items-end">
              <button class="btn btn-success w-100" type="submit">Aplicar</button>
            </div>
          </form>
          <div id="calendar"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<style>
  #calendar { min-height: 700px; }
  .fc-event { cursor: pointer; font-size:11px; }
  .fc-toolbar-title { font-size: 1.05rem; }
  .color-picker-pop { position:absolute; background:#fff; border:1px solid #ccc; padding:6px; border-radius:6px; z-index:9999; box-shadow:0 2px 8px rgba(0,0,0,.15); }
</style>
<script>
  (function(){
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    function showToast(msg,type){
      var container=document.getElementById('toastContainer');
      if(!container){alert(msg);return;};
      var w=document.createElement('div');
      w.className='toast show mb-2';
      w.innerHTML='<div class="toast-header"><strong class="me-auto text-'+(type||'success')+'">'+(type||'Info')+'</strong><button type="button" class="btn-close" data-bs-dismiss="toast"></button></div><div class="toast-body">'+msg+'</div>';
      container.prepend(w);
      try{ new bootstrap.Toast(w,{delay:4000}).show(); }catch(e){}
    }
    document.addEventListener('DOMContentLoaded', function() {
      // Modal element
      var modalEl = document.getElementById('consultModal');
      var bsModal = modalEl ? new bootstrap.Modal(modalEl) : null;
      var calEl = document.getElementById('calendar');
      var params = new URLSearchParams(window.location.search);
      var consultorio = params.get('consultorio') || '';
      var initialMode = 'timeGridWeek';
      var calendar = new FullCalendar.Calendar(calEl, {
        initialView: initialMode,
        slotDuration: '00:30:00',
        allDaySlot: false,
        locale: 'es',
        buttonText: { today:'Hoy', dayGridMonth:'Mes', timeGridWeek:'Semana', timeGridDay:'Día' },
        height: 'auto',
        selectable: true,
        editable: true,
        nowIndicator: true,
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
        events: function(fetchInfo, success, failure){
          var url = '{% url "calendar_events_api" %}?start='+fetchInfo.startStr+'&end='+fetchInfo.endStr+(consultorio?('&consultorio='+consultorio):'');
          fetch(url,{credentials:'same-origin'}).then(r=>r.json()).then(data=>success(data)).catch(err=>failure(err));
        },
        eventDrop: function(info){ updateEventTime(info); },
        eventResize: function(info){ updateEventTime(info); },
        eventClick: function(info){
          var ev = info.event;
          // Populate modal fields
          if(!bsModal) return;
          modalEl.querySelector('#cm-id').value = ev.id;
          modalEl.querySelector('#cm-patient-id').value = ev.extendedProps.patientId || '';
          modalEl.querySelector('#cm-prof-id').value = ev.extendedProps.professionalId || '';
          modalEl.querySelector('#cm-duration').value = ev.extendedProps.duration || 60;
          modalEl.querySelector('#cm-title').textContent = ev.extendedProps.patientName || ev.title || 'Consulta';
          modalEl.querySelector('#cm-status').textContent = ev.extendedProps.statusDisplay || ev.extendedProps.status || '';
          modalEl.querySelector('#cm-consultorio').textContent = ev.extendedProps.consultorio || '';
          modalEl.querySelector('#cm-professional').textContent = ev.extendedProps.professionalName || '';
          modalEl.querySelector('#cm-datetime').textContent = ev.start.toLocaleString();
          modalEl.querySelector('#cm-duration-view').textContent = (ev.extendedProps.duration||60)+' min';
          var colorInput = modalEl.querySelector('#cm-color');
          if(colorInput){
            colorInput.value = ev.backgroundColor || '#64B5F6';
            colorInput.onchange = function(){
              var hex = colorInput.value;
              var pid = ev.extendedProps.patientId;
              if(!pid){ showToast('No hay paciente asociado','warning'); return; }
              fetch('{% url "patient_color_update_api" 0 %}'.replace('/0/','/'+pid+'/'),{
                method:'POST',credentials:'same-origin',headers:{'X-CSRFToken':getCookie('csrftoken'),'Content-Type':'application/x-www-form-urlencoded'},
                body: 'color='+encodeURIComponent(hex)
              }).then(r=>r.json()).then(data=>{
                if(data.ok){ ev.setProp('backgroundColor',hex); ev.setProp('borderColor',hex); showToast('Color actualizado','success'); }
                else showToast(data.message||'Error','danger');
              }).catch(()=>{showToast('Error color','danger');});
            };
          }
          // Reset cancel/reschedule section
          modalEl.querySelector('#cm-action-cancel').checked = true;
          modalEl.querySelector('#cm-resched-section').classList.add('d-none');
          var actCancel = modalEl.querySelector('#cm-action-cancel');
          var actRes = modalEl.querySelector('#cm-action-resched');
          var resSec = modalEl.querySelector('#cm-resched-section');
          function toggleRes(){ resSec.classList.toggle('d-none', !actRes.checked); }
          actCancel.onchange = toggleRes; actRes.onchange = toggleRes;
          // Load slots on date change
          var resDate = modalEl.querySelector('#cm-resched-date');
          var resTime = modalEl.querySelector('#cm-resched-time');
          resDate.value = '';
          resTime.innerHTML = '<option value="">--</option>';
          resDate.onchange = function(){
            var profId = ev.extendedProps.professionalId; if(!profId){ return; }
            var dur = ev.extendedProps.duration || 60;
            if(!resDate.value){ resTime.innerHTML = '<option value="">--</option>'; return; }
            var url = '{% url "available_slots_api" %}?date='+encodeURIComponent(resDate.value)+'&duration='+dur+'&professional_id='+profId;
            fetch(url,{credentials:'same-origin'}).then(r=>r.json()).then(d=>{
              var slots = d.slots||[]; var html='';
              if(slots.length===0){ html='<option value="">Sin horarios</option>'; }
              else { html = slots.map(s=>'<option value="'+s+'">'+s+'</option>').join(''); }
              resTime.innerHTML = html;
            }).catch(()=>{ resTime.innerHTML = '<option value="">Error</option>'; });
          };
          // Confirm action
          modalEl.querySelector('#cm-confirm').onclick = function(){
            var mode = actRes.checked ? 'reschedule' : 'cancel';
            if(mode==='cancel'){
              fetch('{% url "consultation_cancel_api" 0 %}'.replace('/0/','/'+ev.id+'/'),{
                method:'POST',credentials:'same-origin',headers:{'X-CSRFToken':getCookie('csrftoken'),'Content-Type':'application/x-www-form-urlencoded'},
                body:'mode=cancel'
              }).then(r=>r.json()).then(data=>{
                if(data.ok){
                  bsModal.hide();
                  ev.remove();
                  showToast('Consulta cancelada','success');
                } else { showToast(data.message||'Error','danger'); }
              }).catch(()=>showToast('Error al cancelar','danger'));
            } else {
              var d = resDate.value; var t = resTime.value;
              if(!d || !t){ showToast('Seleccione fecha y hora','warning'); return; }
              fetch('{% url "consultation_cancel_api" 0 %}'.replace('/0/','/'+ev.id+'/'),{
                method:'POST',credentials:'same-origin',headers:{'X-CSRFToken':getCookie('csrftoken'),'Content-Type':'application/x-www-form-urlencoded'},
                body:'mode=reschedule&date='+encodeURIComponent(d)+'&time='+encodeURIComponent(t)
              }).then(r=>r.json()).then(data=>{
                if(data.ok){
                  // Update event with new time
                  var startIso = d+'T'+t+':00';
                  var dur = ev.extendedProps.duration||60;
                  var start = new Date(startIso);
                  var end = new Date(start.getTime() + dur*60000);
                  ev.setStart(start); ev.setEnd(end);
                  bsModal.hide();
                  showToast('Consulta reprogramada','success');
                } else { showToast(data.message||'Error','danger'); }
              }).catch(()=>showToast('Error al reprogramar','danger'));
            }
          };
          bsModal.show();
        }
      });
      calendar.render();
      function updateEventTime(info){
        var ev = info.event;
        fetch('{% url "consultation_time_update_api" 0 %}'.replace('/0/','/'+ev.id+'/'),{
          method:'POST',credentials:'same-origin',headers:{'X-CSRFToken':getCookie('csrftoken'),'Content-Type':'application/x-www-form-urlencoded'},
          body:'start='+encodeURIComponent(ev.start.toISOString())+'&end='+encodeURIComponent(ev.end.toISOString())
        }).then(r=>r.json()).then(data=>{ if(!data.ok){ showToast(data.message||'Error','danger'); info.revert(); } else { showToast('Actualizado','success'); } })
          .catch(()=>{ showToast('Error actualización','danger'); info.revert(); });
      }
      document.getElementById('calendarFilters').addEventListener('submit', function(e){
        e.preventDefault();
        var form = e.target;
        var formParams = new URLSearchParams(new FormData(form));
        var newUrl = window.location.pathname+'?'+formParams.toString();
        window.history.replaceState({},'',newUrl);
        consultorio = formParams.get('consultorio')||'';
        calendar.refetchEvents();
      });
    });
  })();
</script>
<!-- Modal for consultation details and cancel/reschedule -->
<div class="modal fade" id="consultModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="cm-title">Consulta</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="cm-id" />
        <input type="hidden" id="cm-patient-id" />
        <input type="hidden" id="cm-prof-id" />
        <input type="hidden" id="cm-duration" />
        <div class="mb-2"><span class="text-secondary text-xxs">Estado:</span> <span class="badge bg-gradient-secondary" id="cm-status"></span></div>
        <div class="mb-2"><span class="text-secondary text-xxs">Fecha y hora:</span> <span id="cm-datetime"></span></div>
        <div class="mb-2"><span class="text-secondary text-xxs">Duración:</span> <span id="cm-duration-view"></span></div>
        <div class="mb-2"><span class="text-secondary text-xxs">Consultorio:</span> <span id="cm-consultorio"></span></div>
        <div class="mb-3"><span class="text-secondary text-xxs">Profesional:</span> <span id="cm-professional"></span></div>
        <div class="mb-3 d-flex align-items-center gap-2">
          <label for="cm-color" class="form-label mb-0 text-xs">Color:</label>
          <input type="color" id="cm-color" class="form-control form-control-color" style="width:60px;">
        </div>
        <hr/>
        <div class="mb-2 text-sm fw-bold">Cancelar o Reprogramar</div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="cm-action" id="cm-action-cancel" checked>
          <label class="form-check-label" for="cm-action-cancel">Cancelar</label>
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" name="cm-action" id="cm-action-resched">
          <label class="form-check-label" for="cm-action-resched">Reprogramar a otra fecha</label>
        </div>
        <div id="cm-resched-section" class="row g-2 d-none">
          <div class="col-6">
            <label class="form-label text-xs">Fecha</label>
            <input type="date" id="cm-resched-date" class="form-control" />
          </div>
          <div class="col-6">
            <label class="form-label text-xs">Hora</label>
            <select id="cm-resched-time" class="form-select"></select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-danger" id="cm-confirm">Confirmar</button>
      </div>
    </div>
  </div>
</div>
{% endblock extra_js %}
